config:
  #incus_command: incus  # default
  project: gfarm-lustre
  idmap: true  # bool or uid
  ssh_authorized_keys: ssh_authorized_keys
  network:
    gflnet1:
      description: "gfarm lustre net1"
      config:
        ipv4.address: 10.123.123.1/24
        ipv4.dhcp.ranges: 10.123.123.101-10.123.123.200
        ipv4.nat: true
    gflnet2:
      description: "gfarm lustre net2"
      config:
        ipv4.address: 10.210.210.1/24
        ipv4.dhcp: false
        ipv4.nat: false
        ipv6.nat: false
        ipv6.address: none
  profile:
    gfarm-lustre:
      description: "gfarm lustre profile1"
      config:
        limits.memory: 2GB
        limits.cpu: 4
      devices:
        root:
          type: disk
          path: /
          pool: mypool
          size: 5GB
    gfarm-lustre-net:
      description: "gfarm lustre profile2"
      devices:
        eth0:
          network: gflnet1
          type: nic
        eth1:
          network: gflnet2
          type: nic

buildimage:
  lustre-server:
    image: images:rockylinux/8
    series: rhel
    vm: true
    devices:
      root:
        size: 8GB
    config:
      limits.memory: 4GB
      limits.cpu: 6
    profile:
      - gfarm-lustre
      - gfarm-lustre-net
    volume:
      - ./SCRIPT:/SCRIPT
    setup:
      - /SCRIPT/install-lustre-server.sh
    publish-remote:
      - incus1
  lustre-client:
    image: images:rockylinux/8
    series: rhel
    vm: true
    profile:
      - gfarm-lustre
      - gfarm-lustre-net
    volume:
      - ./SCRIPT:/SCRIPT
    setup:
      - /SCRIPT/install-lustre-client.sh
    publish-remote:
      - incus1
  gfarm:
    image: images:ubuntu/22.04
    series: rhel
    vm: false
    profile:
      - gfarm-lustre
      - gfarm-lustre-net
    volume:
      - ./SCRIPT:/SCRIPT
    setup:
      - /SCRIPT/install-gfarm.sh
    publish-remote:
      - incus1

host:
  mgs:
    image: incus1:lustre-server
    profile:
      - gfarm-lustre
      - gfarm-lustre-net
    #remote: local  # default
    remote: incus1
    vm: true
    networks:
      eth0:
        #ifname: ens5s0  # (default for VM)
        ipv4: 192.168.1.101
    setup:
      - setup-lustre-mgs.sh
    #entrypoint:
    #  - true
  oss0:
    profile: gfarm-lustre
    image: incus1:lustre-server
    vm: true
    devices:
      root:
        size: 8GB
    networks:
      eth0:
        #ifname: ens5s0 # (default for VM)
        ipv4: 192.168.1.102
    setup:
      - "setup-lustre-oss.sh 0 192.168.1.101"
    #entrypoint:
    #  - true
  lclient1:
    profile: gfarm-lustre
    image: incus1:lustre-client
    vm: true
    networks:
      eth0:
        #ifname: ens5s0 # (default for VM)
        # ipv4: 192.168.1.103  (default: dhcp)
    setup:
      - "setup-lustre-client.sh 0 192.168.1.101"
    #entrypoint:
    #  - true
  gfmd1:
    profile: gfarm-lustre
    image: incus1:gfarm
    vm: false
    networks:
      eth0:
        #ifname: eth0 # (default for container)
        ipv4: 192.168.1.104
    setup:
      - setup-install-gfmd.sh
    #entrypoint:
    #  - entrypoint.sh
  gfsd1:
  gclient1:
  keycloak:

script:
  - test1.sh
  - script1.sh
