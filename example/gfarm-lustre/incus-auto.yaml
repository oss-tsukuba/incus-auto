config:
  #incus_command: incus  # NOTE: default
  project: gfarm-lustre
  idmap: true  # false or true(your host UID) or any UID to root(UID=0)
  #user: incus  # NOTE: default
  #uid: 1000  # NOTE: default
  #ssh_authorized_keys: ssh_authorized_keys  # NOTE: default
  remote:
    local: false  # NOTE: default=local:true
    incus1: true
  network:
    gflnet1:
      description: "gfarm lustre net1"
      config:
        ipv4.address: 10.123.123.1/24
        ipv4.dhcp.ranges: 10.123.123.101-10.123.123.200
        ipv4.nat: true
    gflnet2:
      description: "gfarm lustre net2"
      config:
        ipv4.address: 10.210.210.1/24
        ipv4.dhcp: false
        ipv4.nat: false
        ipv6.nat: false
        ipv6.address: none
  profile:
    prof1:
      description: "gfarm lustre profile1"
      config:
        limits.memory: 2GB
        limits.cpu: 4
        # NOTE: same as "idmap: true"
        # raw.idmap: both 1000 0
        # raw.idmap: |
        #   gid 1000 0
        #   uid 1000 0
      devices:
        root:
          type: disk
          path: /
          pool: mypool
          size: 5GB
        SCRIPT:
          type: disk
          source: ./SCRIPT  # NOTE: cd $(dirname $(realpath incus-auto.yaml)); $(realpath ./SCRIPT) when not an absolute path
          path: /SCRIPT
    prof2net:
      description: "gfarm lustre profile2"
      devices:
        eth0:
          network: gflnet1
          type: nic
        eth1:
          network: gflnet2
          type: nic

buildimage:
  img-lserver:
    image: images:rockylinux/8
    series: rhel
    vm: true
    devices:
      root:
        size: 8GB
      eth0:
        ipv4.address: 10.123.123.191  # NOTE: for ipv4.dhcp=true
    config:
      limits.memory: 4GB
      limits.cpu: 6
    profile:
      - prof1
      - prof2net
    volume:  # TODO
      - ./CONF:/CONF
    setup:
      - bash -x /SCRIPT/install-lustre-server.sh "a b c" "\\d ef"
    publish-remote:
      - incus1
    publish-alias:
      - lserver
      - lustre-server
  # img-lclient:
  #   image: images:rockylinux/8
  #   series: rhel
  #   vm: true
  #   profile:
  #     - prof1
  #     - prof2net
  #   volume:
  #     - ./SCRIPT:/SCRIPT
  #   setup:
  #     - /SCRIPT/install-lustre-client.sh
  #   publish-remote:
  #     - incus1
  img-gfarm:
    image: images:ubuntu/22.04
    series: debian
    vm: false
    devices:
    profile:
      - prof1
      - prof2net
    volume:
      - ./SCRIPT:/SCRIPT
    setup:
      - bash -x /SCRIPT/install-gfarm.sh "OK"
      - __RESTART__
    publish-remote:
      - incus1
    publish-alias:
      - gfarm

host:
  mgs:
    image: incus1:img-lserver
    series: rhel
    vm: true
    profile:
      - prof1
      - prof2net
    #remote: NOT DEFINED  # NOTE: use default server
    remote: incus1
    # network-static:  # TODO
    #   eth0:
    #     ipv4.addresss: 10.123.123.101/24   # convert: NETMASK=255.255.255.0
    #     ipv4.gateway: 10.123.123.1
    #     dns:
    #     - 8.8.8.8
    devices:
      eth0:
        ipv4.address: 10.123.123.101  # in DHCP range
    setup:
      - /SCRIPT/setup-lustre-mgs.sh
  oss0:
    image: incus1:img-lserver
    series: rhel
    vm: true
    profile:
      - prof1
      - prof2net
    devices:
      root:
        size: 8GB
      eth0:
        ipv4.address: 10.123.123.102
    setup:
      - "/SCRIPT/setup-lustre-oss.sh 0 10.123.123.101"
  # lclient1:
  #   image: incus1:img-lclient
  #   series: rhel
  #   vm: true
  #   profile:
  #     - prof1
  #     - prof2net
  #   devices:
  #     eth0:
  #       ipv4.address: 10.123.123.103
  #   setup:
  #     - "/SCRIPT/setup-lustre-client.sh 0 10.123.123.101"
  gfmd1:
    image: incus1:img-gfarm
    series: debian
    vm: false
    profile:
      - prof1
      - prof2net
    devices:
      eth0:
        ipv4.address: 10.123.123.104
    setup:
      - /SCRIPT/setup-install-gfmd.sh
  # gfsd1:
  # gclient1:
  # keycloak:

script:
  - generate-etchosts.sh
  - update-etchosts.h
  - test1.sh
