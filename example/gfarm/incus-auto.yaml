config:
  #incus_command: incus  # NOTE: default
  project: gfarm  # namespace
  idmap: true  # false or true(your host UID) or any UID to root(UID=0)
  #user: incus  # NOTE: default
  user: gfadm
  #uid: 1000  # NOTE: default
  #ssh_authorized_keys: ssh_authorized_keys  # NOTE: default
  ssh_authorized_keys: sample-id_ecdsa.pub
  remote:
    local: false  # NOTE: default=local:true
    incus1: true
  network:
    gfarm1: # witout project name
      description: "gfarm net1"
      config:
        ipv4.address: 10.123.123.1/24
        ipv4.dhcp.ranges: 10.123.123.101-10.123.123.200
        ipv4.nat: true
    gfarm2:
      description: "gfarm net2"
      config:
        ipv4.address: 10.210.210.1/24
        ipv4.dhcp: false
        ipv4.nat: false
        ipv6.nat: false
        ipv6.address: none
  profile:
    prof1: # with project name
      description: "gfarm profile1"
      config:
        limits.memory: 2GB
        limits.cpu: 4
        # NOTE: same as "idmap: true"
        # raw.idmap: both 1000 0
        # raw.idmap: |
        #   gid 1000 0
        #   uid 1000 0
      devices:
        root:
          type: disk
          path: /
          pool: mypool
          size: 5GB
        SCRIPT:
          type: disk
          source: ./SCRIPT  # NOTE: convert to absolute path
          path: /SCRIPT
    prof2net:
      description: "gfarm profile2"
      devices:
        eth0:
          network: gfarm1
          type: nic
        eth1:
          network: gfarm2
          type: nic

buildimage:
  img-lserver:
    remote: incus1  #TODO # default: not defined
    image: images:rockylinux/8
    series: rhel
    vm: true
    devices:
      root:
        size: 8GB
      # eth0:
      #  ipv4.address: 10.123.123.191  # NOTE: for ipv4.dhcp=true
    config:
      limits.memory: 4GB
      limits.cpu: 6
    profile:
      - prof1
      - prof2net
    setup:
      - bash -x /SCRIPT/install-lustre-server.sh "TODO" "a b c" "\\d ef"
    # publish-remote:  # default: local
    #   - incus1
    publish-alias:
      - img-lserver  # short name (without project_name prefix)
      - img-lustre-server
  # img-lclient:
  #   image: images:rockylinux/8
  #   series: rhel
  #   vm: true
  #   profile:
  #     - prof1
  #     - prof2net
  #   volume:
  #     - ./SCRIPT:/SCRIPT
  #   setup:
  #     - /SCRIPT/install-lustre-client.sh
  #   publish-remote:
  #     - incus1
  img-gfarm:
    image: images:ubuntu/22.04
    series: debian
    vm: false
    devices:
    profile:
      - prof1
      - prof2net
    volume:
      - ./SCRIPT:/SCRIPT
    setup:
      - bash -x /SCRIPT/install-gfarm.sh "TODO"
      - __RESTART__
    # publish-remote:
    #   - incus1
    publish-alias:
      - img-gfarm  # short name

host:
  mgs:
    group: lustre  #TODO?
    alternative:
      - mgs.test
      - mgs.example.org
    image: incus1:gfarm-img-lserver  # image alias (fullname)
    series: rhel
    vm: true
    profile:
      - prof1
      - prof2net
    #remote: <NOT DEFINED>  # NOTE: use default server
    remote: incus1
    network-static:  # TODO
      eth0:
        ipv4.address: 10.123.123.201/24   # convert: NETMASK=255.255.255.0
        ipv4.gateway: 10.123.123.1
        dns:
        - 8.8.8.8
        - 8.8.4.4
      eth1:
        ipv4.address: 10.210.210.201/24
    devices:
      root:
        size: 8GB
      # eth0:
      #   ipv4.address: 10.123.123.101  # in DHCP range
    setup:
      - bash -x /SCRIPT/setup-lustre-mgs.sh "TODO"
  # oss0:
  #   image: incus1:img-lserver
  #   series: rhel
  #   vm: true
  #   profile:
  #     - prof1
  #     - prof2net
  #   devices:
  #     root:
  #       size: 8GB
  #     eth0:
  #       ipv4.address: 10.123.123.102
  #   setup:
  #     - "/SCRIPT/setup-lustre-oss.sh 0 10.123.123.101"
  # lclient1:
  #   image: incus1:img-lclient
  #   series: rhel
  #   vm: true
  #   profile:
  #     - prof1
  #     - prof2net
  #   devices:
  #     eth0:
  #       ipv4.address: 10.123.123.103
  #   setup:
  #     - "/SCRIPT/setup-lustre-client.sh 0 10.123.123.101"
  gfmd1:
    group: gfarm:gfmd  #TODO?
    image: incus1:gfarm-img-gfarm
    series: debian
    vm: false
    profile:
      - prof1
      - prof2net
    network-static:  # TODO
      eth0:
        ipv4.address: 10.123.123.204/24
        ipv4.gateway: 10.123.123.1
        dns:
        - 8.8.8.8
      eth1:
        ipv4.address: 10.210.210.204/24
    devices:  # ignored when networ-static.*.ipv4.address is defined
      eth0:
        ipv4.address: 10.123.123.104
    setup:
      - bash -x /SCRIPT/setup-gfmd.sh "TODO"
  # gfmd2:
  # gfmd3:
  # gfsd1:
  #  group: gfarm:gfsd  #TODO?
  # gfsd2:
  # gfsd3:
  # gfsd4:
  # gfclient1:
  # keycloak:
  # jwt-server:
  manage:
    image: images:ubuntu/22.04
    series: debian
    vm: false
    profile:
      - prof1
      - prof2net
    volume:  # TODO
      - ./CONF:/CONF
      - ./:/INCUS-AUTO
    network-static:
      eth0:
        ipv4.address: 10.123.123.231/24
        ipv4.gateway: 10.123.123.1
        dns:
        - 8.8.8.8
        - 8.8.4.4
      eth1:
        ipv4.address: 10.210.210.231/24
    setup:
      - bash -x /SCRIPT/base-for-ubuntu.sh
      - bash -x /SCRIPT/install-ansible-for-ubuntu.sh
  # manage-alma9:
  #   image: images:almalinux/9
  #   series: rhel
  #   vm: False
  #   profile:
  #     - prof1
  #     - prof2net
  #   volume:  # TODO
  #     - ./CONF:/CONF
  #   network-static:
  #     eth0:
  #       ipv4.address: 10.123.123.232/24
  #       ipv4.gateway: 10.123.123.1
  #       dns:
  #       - 8.8.8.8
  #       - 8.8.4.4
  #     eth1:
  #       ipv4.address: 10.210.210.232/24

post-setup:  # TODO
  - manage-ub22:/SCRIPT/setup-ansible.sh
  - __ALL__:/SCRIPT/generate-etchosts.sh
  - __LOCAL__:./SCRIPT/update-etchosts.h
