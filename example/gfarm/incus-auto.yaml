config:
  #incus_command: incus  # NOTE: default
  project: gfarm  # namespace
  idmap: true  # false|true(your host UID)/any host UID| to container user
  #user: admin  # NOTE: default
  user: gfarmsys  # superuser in container
  #uid: 1000  # NOTE: default
  #ssh_authorized_keys: ssh_authorized_keys  # NOTE: default
  ssh_authorized_keys: sample-id_ecdsa.pub
  # etchosts: true  # NOTE: default
  # envvar:
  #   http_proxy: http://...
  #   https_proxy: http://...
  remote:
    local: false  # NOTE: default=local:true
    incus1: true
  network:
    gfarm1: # witout project name
      description: "gfarm net1"
      config:
        ipv4.address: 10.123.123.1/24
        ipv4.dhcp.ranges: 10.123.123.101-10.123.123.200
        ipv4.nat: true
    gfarm2:
      description: "gfarm net2"
      config:
        ipv4.address: 10.210.210.1/24
        ipv4.dhcp: false
        ipv4.nat: false
        ipv6.nat: false
        ipv6.address: none
  profile:
    prof1: # with project name
      description: "gfarm profile1"
      config:
        limits.memory: 2GB
        limits.cpu: 4
        # NOTE: same as "idmap: true"
        # raw.idmap: both 1000 0
        # raw.idmap: |
        #   gid 1000 0
        #   uid 1000 0
      devices:
        root:
          type: disk
          path: /
          pool: mypool
          size: 5GB
        SCRIPT:
          type: disk
          source: ./SCRIPT  # NOTE: convert to absolute path
          path: /SCRIPT
    prof2net:
      description: "gfarm profile2"
      devices:
        eth0:
          network: gfarm1
          type: nic
        eth1:
          network: gfarm2
          type: nic

buildimage:
  img-lserver:
    image: images:rockylinux/8
    series: rhel
    vm: true
    devices:
      root:
        size: 6GB
      # eth0:
      #  ipv4.address: 10.123.123.191  # NOTE: for ipv4.dhcp=true
    config:
      limits.memory: 4GB
      limits.cpu: 6
      security.secureboot: false
    profile:
      - prof1
      - prof2net
    volume:
      - ./CONF:/CONF
    setup:
      - bash -x /SCRIPT/install-lustre-server.sh
    # "Error: The source and target servers must be different" if "remote name" and localost are the same
    # publish-remote:  # default: local
    #   - incus1
    publish-alias:  # MUST
      - img-lserver  # short name (without project_name prefix)
      - img-lustre-server
  img-lclient:
    image: images:rockylinux/8
    series: rhel
    vm: true
    profile:
      - prof1
      - prof2net
    volume:
      - ./SRC:/SRC
    setup:
      - bash -x /SCRIPT/install-lustre-client.sh
    # publish-remote:
    #   - incus1
    publish-alias:  # MUST
      - img-lclient
      - img-lustre-client
  img-gfarm:
    image: images:ubuntu/22.04
    series: debian
    vm: false
    devices:
    profile:
      - prof1
      - prof2net
    volume:
      - ./CONF:/CONF
      - ./SRC:/SRC
    # envvar:
    setup:
      - bash -x /SCRIPT/install-gfarm.sh
      - __RESTART__
    # publish-remote:  #TODO
    #   - incus1
    publish-alias:
      - img-gfarm  # short name

x-gfarm: &x-gfarm
  image: gfarm-img-gfarm
  series: debian
  vm: false
  profile:
    - prof1
    - prof2net
  volume:
    - ./CONF:/CONF
    - ./SRC:/SRC
    - ./BACKUP:/BACKUP
  # envvar:

host:
  gfmd1:
    <<: [*x-gfarm]
    group: gfarm/gfmd  #TODO?
    alternative:
      - gfmd1.test
      - gfmd1.example.org
    # network-static:
    #   eth0:
    #     ipv4.address: 10.123.123.211/24
    #     ipv4.gateway: 10.123.123.1
    #     dns:
    #     - 8.8.8.8
    #   eth1:
    #     ipv4.address: 10.210.210.211/24
    devices:  # ignored when network-static.*.ipv4.address is defined
      eth0:
        ipv4.address: 10.123.123.101
  gfmd2:
    <<: [*x-gfarm]
    group: gfarm/gfmd  #TODO?
    devices:
      eth0:
        ipv4.address: 10.123.123.102
  gfmd3:
    <<: [*x-gfarm]
    group: gfarm/gfmd  #TODO?
    devices:
      eth0:
        ipv4.address: 10.123.123.103
  gfsd1:
    <<: [*x-gfarm]
    group: gfarm/gfsd  #TODO?
    devices:
      eth0:
        ipv4.address: 10.123.123.111
  gfsd2:
    <<: [*x-gfarm]
    group: gfarm/gfsd  #TODO?
    devices:
      eth0:
        ipv4.address: 10.123.123.112
  # gfsd3:
  # gfsd4:
  gfclient1:
    <<: [*x-gfarm]
    group: gfarm/client  #TODO?
    devices:
      eth0:
        ipv4.address: 10.123.123.121
  keycloak:
    <<: [*x-gfarm]
    group: gfarm/client  #TODO?
    devices:
      eth0:
        ipv4.address: 10.123.123.131
  jwtserver:
    <<: [*x-gfarm]
    group: gfarm/client  #TODO?
    devices:
      eth0:
        ipv4.address: 10.123.123.132
  manage:
    image: images:ubuntu/22.04
    series: debian
    vm: false
    profile:
      - prof1
      - prof2net
    volume:  # TODO
      - ./CONF:/CONF
      - ./:/SECRET
    network-static:
      eth0:
        ipv4.address: 10.123.123.251/24
        ipv4.gateway: 10.123.123.1
        dns:
        - 8.8.8.8
        - 8.8.4.4
      eth1:
        ipv4.address: 10.210.210.251/24
    setup:
      - bash -x /SCRIPT/base-for-ubuntu.sh
      - bash -x /SCRIPT/install-ansible-for-ubuntu.sh
  # alma9:
  #   image: images:almalinux/9
  #   series: rhel
  #   vm: False
  #   profile:
  #     - prof1
  #     - prof2net
  #   volume:  # TODO
  #     - ./CONF:/CONF
  #   network-static:
  #     eth0:
  #       ipv4.address: 10.123.123.252/24
  #       ipv4.gateway: 10.123.123.1
  #       dns:
  #       - 8.8.8.8
  #       - 8.8.4.4
  #     eth1:
  #       ipv4.address: 10.210.210.252/24
  #   envvar:
  #     TESTENV: abcdefg
  #
  mgs:
    group: lustre  #TODO?
    alternative:
      - mgs.test
      - mgs.example.org
    image: gfarm-img-lserver  # image alias (fullname)
    series: rhel
    vm: true
    profile:
      - prof1
      - prof2net
    #remote: <NOT DEFINED>  # NOTE: use default server
    remote: incus1
    volume:
      - ./CONF:/CONF
      - ./SRC:/SRC
      - ./BACKUP:/BACKUP
    config:
      limits.memory: 4GB
      limits.cpu: 6
      security.secureboot: false
    block-device:
      lustre-mdt:
        pool: mypool
        size: 5GB
        delete: false  # true: delete the block before building
    devices:
      root:
       size: 6GB  # equal to or larger than the image
      eth0:
        ipv4.address: 10.123.123.151  # in DHCP range
    setup:
      - bash -x /SCRIPT/setup-lustre-mgs.sh
      - __RESTART__

  # oss0:
  #   image: incus1:img-lserver
  #   series: rhel
  #   vm: true
  #   profile:
  #     - prof1
  #     - prof2net
  #   devices:
  #     root:
  #       size: 8GB
  #     eth0:
  #       ipv4.address: 10.123.123.152
  #   setup:
  #     - "/SCRIPT/setup-lustre-oss.sh 0 10.123.123.151"
  # lclient1:
  #   image: incus1:img-lclient
  #   series: rhel
  #   vm: true
  #   profile:
  #     - prof1
  #     - prof2net
  #   devices:
  #     eth0:
  #       ipv4.address: 10.123.123.153
  #   setup:
  #     - "/SCRIPT/setup-lustre-client.sh 0 10.123.123.151"
